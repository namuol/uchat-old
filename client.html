<html>
    <head>
        <script src='http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
        <script src='/socket.io/socket.io.js'></script>
        <script src='http://jtemplates.tpython.com/jquery-jtemplates.js'></script>
        <link rel='stylesheet' type='text/css' href='/client.css' />
    </head>
    <body>
        <div id='status-msg'>
        </div>

        <form id='join-form'>
            <input id='name' type='text' />
        </form>

        <div id='chat-panel' class='disabled' style='display: none'> 
            <div>
                <ul id='msgs'>
                </ul>
            </div>

            <div id='msg-bar'>
                <form id='msg-form'>
                    <input id='msg' type='text' />
                </form>
            </div>

        </div>
        
        <textarea id='joined-jtpl' style='display:none'>
            <li><span class='timestamp'>{timeString($T.time)}</span><span class='joined-name'>{$T.name}</span><span class='joined'>joined</span></li>
        </textarea>

        <textarea id='left-jtpl' style='display:none'>
            <li><span class='timestamp'>{timeString($T.time)}</span><span class='left-name'>{$T.name}</span><span class='left'>left</span></li>
        </textarea>

        <textarea id='msg-jtpl' style='display:none'>
            <li><span class='timestamp'>{timeString($T.time)}</span><span class='msg-name'>{$T.name}</span><span class='msg'>{$T.msg}</span></li>
        </textarea>
        <script type='text/javascript'>
            /////////////////////////////////////////
            // SOCKET.IO
            var socket = new io.Socket();
            $('#join-form').hide();
            $('#status-msg').html('connecting...');

            socket.on('connect', function(){
                $('#status-msg').html('who are you?');
                $('#status-msg').show();
                $('#join-form').show();
                $('#name').focus();
                $('input').attr('disabled',false);
            });

            socket.on('message',function(data){
                switch(data.type) {
                case 'joined':
                case 'left':
                case 'msg':
                    jtpl = jQuery.createTemplate($('#'+data.type+'-jtpl').val());
                    txt = jQuery.processTemplateToText(jtpl, data);
                    $('#msgs').append(txt);

                    window.scrollBy(0,99999999999999);
                    $('#msg').focus();
                    break;
                }
            });

            socket.on('disconnect', function() {
                $('#status-msg').html('error/disconnected :(');
                $('#status-msg').show();
                $('input').attr('disabled','disabled');
                $('body').addClass('disabled');
            });

            socket.connect();
            // SOCKET.IO
            /////////////////////////////////////////

            /////////////////////////////////////////
            // UI BEHAVIOR
            
            function timeString(time) {
                d = new Date(time);
                h = d.getHours();
                h = h < 10 ? "0" + h : h;
                m = d.getMinutes();
                m = m < 10 ? "0" + m : m;
                s = d.getSeconds();
                s = s < 10 ? "0" + s : s;
                return h + ":" + m + ":" + s;
            }

            $('#name').focus();
            $('#msg').attr('disabled',true);

            $('#join-form').submit( function() {
                socket.send({
                    type: 'join',
                    name: $('#name').val()
                });
                $('#status-msg').hide();
                $('#join-form').hide();
                $('#chat-panel').show();
                return false;
            });

            $('#msg-form').submit( function() {
                socket.send({
                    type: 'msg',
                    msg: $('#msg').val()
                });

                $('#msg').val('');
                return false;
            });

            // UI BEHAVIOR
            /////////////////////////////////////////

        </script>

    </body>
</html>
